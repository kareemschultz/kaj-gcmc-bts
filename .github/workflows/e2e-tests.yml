name: ğŸ­ E2E Tests - GCMC-KAJ Platform

on:
  push:
    branches: [main, develop, 'feature/**', 'hotfix/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC for regression testing
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - 'smoke'
          - 'regression'
          - 'full'
          - 'api-only'
          - 'visual-only'
      browser:
        description: 'Browser to test'
        required: true
        default: 'chromium'
        type: choice
        options:
          - 'chromium'
          - 'firefox'
          - 'webkit'
          - 'all'
      parallel_jobs:
        description: 'Number of parallel jobs'
        required: true
        default: '4'
        type: choice
        options:
          - '1'
          - '2'
          - '4'
          - '6'
          - '8'

env:
  NODE_VERSION: '20'
  BUN_VERSION: '1.3.2'
  PLAYWRIGHT_VERSION: '1.56.1'

jobs:
  # Setup and Validation Job
  setup:
    name: ğŸš€ Setup & Validation
    runs-on: ubuntu-latest
    outputs:
      test-strategy: ${{ steps.strategy.outputs.strategy }}
      should-run-smoke: ${{ steps.strategy.outputs.smoke }}
      should-run-api: ${{ steps.strategy.outputs.api }}
      parallel-jobs: ${{ steps.strategy.outputs.parallel }}
    steps:
      - name: ğŸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“‹ Determine Test Strategy
        id: strategy
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SUITE="${{ github.event.inputs.test_suite }}"
            PARALLEL="${{ github.event.inputs.parallel_jobs }}"
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            SUITE="regression"
            PARALLEL="6"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            SUITE="full"
            PARALLEL="4"
          else
            SUITE="smoke"
            PARALLEL="2"
          fi

          echo "strategy=$SUITE" >> $GITHUB_OUTPUT
          echo "parallel=$PARALLEL" >> $GITHUB_OUTPUT

          # Set flags for different test types
          echo "smoke=$([[ $SUITE == "smoke" || $SUITE == "full" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "api=$([[ $SUITE == "api-only" || $SUITE == "full" || $SUITE == "smoke" ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile

  # Build Application Job
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ğŸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ—ï¸ Build Application
        run: bun run build
        env:
          NODE_ENV: production

  # Smoke Tests Job
  smoke-tests:
    name: ğŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.should-run-smoke == 'true'
    strategy:
      matrix:
        browser: [chromium, firefox]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: gcmc_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: gcmc_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ­ Install Playwright Browsers
        run: bun playwright install ${{ matrix.browser }} --with-deps

      - name: ğŸ—„ï¸ Setup Database
        run: |
          bun run db:push || true
        env:
          DATABASE_URL: postgresql://gcmc_test:test_password@localhost:5432/gcmc_test
          REDIS_URL: redis://localhost:6379

      - name: ğŸš€ Start Application
        run: |
          bun run dev:web &
          bun run dev:server &
          timeout 60 bash -c 'until curl -f http://localhost:3001 2>/dev/null; do sleep 2; done'
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://gcmc_test:test_password@localhost:5432/gcmc_test
          REDIS_URL: redis://localhost:6379

      - name: ğŸ§ª Run Smoke Tests
        run: bun run test:e2e:smoke --project=${{ matrix.browser }}
        env:
          CI: true
          NEXT_PUBLIC_APP_URL: http://localhost:3001

      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
            allure-results/

  # API Tests Job
  api-tests:
    name: ğŸ”Œ API Tests
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.should-run-api == 'true'
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: gcmc_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: gcmc_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ—„ï¸ Setup Database
        run: |
          bun run db:push || true
        env:
          DATABASE_URL: postgresql://gcmc_test:test_password@localhost:5432/gcmc_test

      - name: ğŸš€ Start API Server
        run: |
          bun run dev:server &
          timeout 60 bash -c 'until curl -f http://localhost:3003/health 2>/dev/null; do sleep 2; done'
        env:
          DATABASE_URL: postgresql://gcmc_test:test_password@localhost:5432/gcmc_test
          REDIS_URL: redis://localhost:6379

      - name: ğŸ§ª Run API Tests
        run: bun run test:e2e:api
        env:
          CI: true
          NEXT_PUBLIC_API_URL: http://localhost:3003

      - name: ğŸ“Š Upload API Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: |
            test-results/
            playwright-report/
            allure-results/

  # Generate Reports Job
  generate-reports:
    name: ğŸ“‹ Generate Reports
    runs-on: ubuntu-latest
    needs: [smoke-tests, api-tests]
    if: always()
    steps:
      - name: ğŸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download All Test Results
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts

      - name: ğŸ”§ Setup Node.js for Allure
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Allure CLI
        run: npm install -g allure-commandline

      - name: ğŸ“‹ Merge Allure Results
        run: |
          mkdir -p merged-allure-results
          find test-artifacts -name "allure-results" -type d -exec cp -r {}/* merged-allure-results/ \; 2>/dev/null || true

      - name: ğŸ“Š Generate Allure Report
        run: allure generate merged-allure-results --clean -o allure-report

      - name: ğŸ“¤ Upload Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

  # Notification Job
  notify:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [generate-reports]
    if: always()
    steps:
      - name: ğŸ“¢ Notify on Success
        if: ${{ needs.generate-reports.result == 'success' }}
        run: echo "âœ… E2E Tests Passed Successfully!"

      - name: ğŸ“¢ Notify on Failure
        if: ${{ needs.generate-reports.result == 'failure' }}
        run: echo "âŒ E2E Tests Failed! Check artifacts for details."
