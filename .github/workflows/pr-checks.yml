name: PR Checks

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  pr-title-check:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

  breaking-changes-check:
    name: Check for Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for breaking changes
        id: breaking
        run: |
          # Check if PR title or body contains BREAKING CHANGE
          if [[ "${{ github.event.pull_request.title }}" =~ "BREAKING CHANGE" ]] || \
             [[ "${{ github.event.pull_request.body }}" =~ "BREAKING CHANGE" ]]; then
            echo "has_breaking=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ This PR contains breaking changes!"
          else
            echo "has_breaking=false" >> $GITHUB_OUTPUT
            echo "âœ… No breaking changes detected"
          fi

      - name: Comment on PR if breaking changes found
        if: steps.breaking.outputs.has_breaking == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **Breaking Change Detected**\n\nThis PR contains breaking changes. Please ensure:\n- [ ] Migration guide is included\n- [ ] Major version bump is planned\n- [ ] Team is notified'
            })

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.18

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run security audit
        id: audit
        run: |
          bun pm audit --json > audit-results.json || true
          if [ -s audit-results.json ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Comment audit results on PR
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let auditResults = '';
            try {
              const results = fs.readFileSync('audit-results.json', 'utf8');
              auditResults = '```json\n' + results + '\n```';
            } catch (e) {
              auditResults = 'Unable to read audit results';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ”’ **Security Audit Results**\n\n' + auditResults
            })

  bundle-size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.18

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            **/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Build for bundle size analysis
        run: bun run build
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          BETTER_AUTH_SECRET: test-secret
          NEXT_PUBLIC_APP_URL: http://localhost:3001
          NEXT_PUBLIC_API_URL: http://localhost:3000
          NODE_ENV: production

      - name: Analyze bundle size
        id: analyze
        run: |
          echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check Next.js build output
          if [ -d "apps/web/.next" ]; then
            echo "### Web App (Next.js)" >> $GITHUB_STEP_SUMMARY
            if [ -f "apps/web/.next/build-manifest.json" ]; then
              WEB_SIZE=$(du -sh apps/web/.next | cut -f1)
              echo "- Total build size: \`$WEB_SIZE\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Check server build
          if [ -d "apps/server/dist" ]; then
            SERVER_SIZE=$(du -sh apps/server/dist | cut -f1)
            echo "### Server App" >> $GITHUB_STEP_SUMMARY
            echo "- Build size: \`$SERVER_SIZE\`" >> $GITHUB_STEP_SUMMARY
          fi

          # Check worker build
          if [ -d "apps/worker/dist" ]; then
            WORKER_SIZE=$(du -sh apps/worker/dist | cut -f1)
            echo "### Worker App" >> $GITHUB_STEP_SUMMARY
            echo "- Build size: \`$WORKER_SIZE\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment bundle size on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            let comment = '## ðŸ“¦ Bundle Size Report\n\n';

            // Get sizes
            try {
              const webSize = execSync('du -sh apps/web/.next 2>/dev/null || echo "N/A"').toString().trim().split('\t')[0];
              const serverSize = execSync('du -sh apps/server/dist 2>/dev/null || echo "N/A"').toString().trim().split('\t')[0];
              const workerSize = execSync('du -sh apps/worker/dist 2>/dev/null || echo "N/A"').toString().trim().split('\t')[0];

              comment += '| App | Size |\n';
              comment += '|-----|------|\n';
              comment += `| Web | \`${webSize}\` |\n`;
              comment += `| Server | \`${serverSize}\` |\n`;
              comment += `| Worker | \`${workerSize}\` |\n`;
            } catch (e) {
              comment += 'Unable to calculate bundle sizes\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-3.0, AGPL-3.0

  pr-stats:
    name: PR Statistics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate PR stats
        id: stats
        run: |
          # Get changed files count
          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)

          # Get lines added/removed
          LINES_ADDED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{sum+=$1} END {print sum}')
          LINES_REMOVED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{sum+=$2} END {print sum}')

          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_removed=$LINES_REMOVED" >> $GITHUB_OUTPUT

      - name: Comment PR stats
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const stats = {
              filesChanged: '${{ steps.stats.outputs.files_changed }}',
              linesAdded: '${{ steps.stats.outputs.lines_added }}',
              linesRemoved: '${{ steps.stats.outputs.lines_removed }}'
            };

            let comment = '## ðŸ“Š PR Statistics\n\n';
            comment += `- **Files changed:** ${stats.filesChanged}\n`;
            comment += `- **Lines added:** +${stats.linesAdded}\n`;
            comment += `- **Lines removed:** -${stats.linesRemoved}\n`;
            comment += `- **Net change:** ${parseInt(stats.linesAdded) - parseInt(stats.linesRemoved)} lines\n`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('PR Statistics')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
