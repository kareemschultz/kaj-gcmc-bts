name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment for migration"
        required: true
        type: choice
        options:
          - staging
          - production
      migration_action:
        description: "Migration action"
        required: true
        type: choice
        options:
          - deploy
          - status
          - reset
      backup_before_migration:
        description: "Create backup before migration"
        required: true
        type: boolean
        default: true
      dry_run:
        description: "Dry run (preview changes without applying)"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    steps:
      - name: Validate environment
        run: |
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Action: ${{ github.event.inputs.migration_action }}"
          echo "Backup: ${{ github.event.inputs.backup_before_migration }}"
          echo "Dry run: ${{ github.event.inputs.dry_run }}"

      - name: Require approval for production
        if: github.event.inputs.environment == 'production'
        run: |
          echo "‚ö†Ô∏è PRODUCTION MIGRATION REQUESTED"
          echo "This workflow will modify the production database."
          echo "Ensure you have proper authorization and backups."

  backup-database:
    name: Backup Database
    runs-on: ubuntu-latest
    needs: [validate-inputs]
    if: github.event.inputs.backup_before_migration == 'true' && github.event.inputs.migration_action == 'deploy'
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.18

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create database backup
        id: backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="backup_${TIMESTAMP}.sql"

          # Extract database credentials from DATABASE_URL
          # Format: postgresql://user:password@host:port/dbname
          DB_URL="${{ secrets.DATABASE_URL }}"

          echo "Creating backup: $BACKUP_FILE"

          # Create backup using pg_dump
          pg_dump "$DB_URL" > "$BACKUP_FILE"

          # Compress backup
          gzip "$BACKUP_FILE"

          echo "backup_file=${BACKUP_FILE}.gz" >> $GITHUB_OUTPUT
          echo "‚úÖ Backup created: ${BACKUP_FILE}.gz"

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.event.inputs.environment }}-${{ github.run_id }}
          path: "*.sql.gz"
          retention-days: 30

      - name: Verify backup
        run: |
          BACKUP_SIZE=$(stat -f%z "${{ steps.backup.outputs.backup_file }}" 2>/dev/null || stat -c%s "${{ steps.backup.outputs.backup_file }}")
          echo "Backup size: $BACKUP_SIZE bytes"
          if [ "$BACKUP_SIZE" -lt 100 ]; then
            echo "‚ùå Backup file is too small, possibly corrupted"
            exit 1
          fi
          echo "‚úÖ Backup verification passed"

  run-migration:
    name: Run Database Migration
    runs-on: ubuntu-latest
    needs: [backup-database]
    if: always() && (needs.backup-database.result == 'success' || needs.backup-database.result == 'skipped')
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.18

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check migration status
        if: github.event.inputs.migration_action == 'status'
        run: |
          echo "Checking migration status..."
          cd packages/db
          bunx prisma migrate status
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Deploy migrations (dry run)
        if: github.event.inputs.dry_run == 'true' && github.event.inputs.migration_action == 'deploy'
        run: |
          echo "üîç DRY RUN MODE - No changes will be applied"
          echo "Migrations that would be applied:"
          cd packages/db
          bunx prisma migrate diff \
            --from-schema-datamodel prisma/schema.prisma \
            --to-schema-datasource prisma/schema.prisma \
            --script
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Deploy migrations
        if: github.event.inputs.dry_run == 'false' && github.event.inputs.migration_action == 'deploy'
        id: migrate
        run: |
          echo "üöÄ Deploying migrations to ${{ github.event.inputs.environment }}"
          cd packages/db
          bunx prisma migrate deploy
          echo "‚úÖ Migrations deployed successfully"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Reset database (DANGEROUS)
        if: github.event.inputs.migration_action == 'reset' && github.event.inputs.environment != 'production'
        run: |
          echo "‚ö†Ô∏è RESETTING DATABASE - This will delete all data!"
          cd packages/db
          bunx prisma migrate reset --force
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Prevent production reset
        if: github.event.inputs.migration_action == 'reset' && github.event.inputs.environment == 'production'
        run: |
          echo "‚ùå Database reset is not allowed in production!"
          exit 1

      - name: Generate Prisma Client
        if: github.event.inputs.migration_action == 'deploy'
        run: |
          cd packages/db
          bunx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  verify-migration:
    name: Verify Migration
    runs-on: ubuntu-latest
    needs: [run-migration]
    if: github.event.inputs.migration_action == 'deploy' && github.event.inputs.dry_run == 'false'
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.18

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify database schema
        run: |
          echo "Verifying database schema..."
          cd packages/db
          bunx prisma validate
          bunx prisma migrate status
          echo "‚úÖ Schema validation passed"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add basic database connectivity tests here
          cd packages/db
          bunx prisma db execute --stdin <<SQL
          SELECT 1 as health_check;
          SQL
          echo "‚úÖ Smoke tests passed"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: true

  rollback:
    name: Rollback Migration
    runs-on: ubuntu-latest
    needs: [verify-migration]
    if: failure() && github.event.inputs.backup_before_migration == 'true'
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Download backup
        uses: actions/download-artifact@v4
        with:
          name: db-backup-${{ github.event.inputs.environment }}-${{ github.run_id }}

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Restore database from backup
        run: |
          echo "‚ö†Ô∏è Migration failed, restoring from backup..."

          # Find backup file
          BACKUP_FILE=$(ls *.sql.gz | head -n 1)
          echo "Restoring from: $BACKUP_FILE"

          # Decompress and restore
          gunzip -c "$BACKUP_FILE" | psql "${{ secrets.DATABASE_URL }}"

          echo "‚úÖ Database restored from backup"

      - name: Verify restoration
        run: |
          echo "Verifying database restoration..."
          psql "${{ secrets.DATABASE_URL }}" -c "SELECT 1 as health_check;"
          echo "‚úÖ Restoration verified"

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [run-migration, verify-migration]
    if: always()
    steps:
      - name: Migration summary
        run: |
          echo "## Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${{ github.event.inputs.migration_action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup Created:** ${{ github.event.inputs.backup_before_migration }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Migration Status:** ${{ needs.run-migration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verification Status:** ${{ needs.verify-migration.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.run-migration.result }}" == "success" ] && [ "${{ needs.verify-migration.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **Migration completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå **Migration failed or was skipped**" >> $GITHUB_STEP_SUMMARY
          fi

      # Optional: Add notification to Slack/Discord
      # - name: Notify team
      #   if: github.event.inputs.environment == 'production'
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "Database migration ${{ needs.run-migration.result }} in ${{ github.event.inputs.environment }}"
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
