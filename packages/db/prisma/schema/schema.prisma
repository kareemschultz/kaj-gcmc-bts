// Prisma schema for GCMC-KAJ â€“ Multi-tenant SaaS Platform with Better-Auth
// Merged schema: Better-Auth authentication + Multi-tenant business logic

generator client {
  provider     = "prisma-client-js"
  output       = "../generated"
  moduleFormat = "esm"
  runtime      = "bun"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION (Better-Auth Models)
// ============================================================================

model User {
  id            String   @id @default(cuid()) @map("_id")
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  phone         String?
  avatarUrl     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions      Session[]
  accounts      Account[]
  tenantUsers   TenantUser[]
  portalClientAccesses ClientPortalAccess[]
  messages      Message[]      @relation("MessageAuthor")
  tasks         Task[]         @relation("TaskAssignee")
  notifications Notification[] @relation("NotificationRecipient")
  auditLogs     AuditLog[]     @relation("AuditActor")

  @@map("user")
}

model Session {
  id        String   @id @default(cuid()) @map("_id")
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid()) @map("_id")
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String    @id @default(cuid()) @map("_id")
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verification")
}

// ============================================================================
// MULTI-TENANT CORE
// ============================================================================

model Tenant {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   @unique
  contactInfo Json?
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantUsers             TenantUser[]
  clients                 Client[]
  clientBusinesses        ClientBusiness[]
  documentTypes           DocumentType[]
  filingTypes             FilingType[]
  services                Service[]
  recurringFilings        RecurringFiling[]
  notifications           Notification[]
  auditLogs               AuditLog[]
  subscriptions           Subscription[]
  complianceRuleSets      ComplianceRuleSet[]
  conversations           Conversation[]
  tasks                   Task[]
  clientTasks             ClientTask[]
  serviceRequestTemplates ServiceRequestTemplate[]
  serviceRequests         ServiceRequest[]
  filings                 Filing[]
  documents               Document[]
  complianceScores        ComplianceScore[]
  requirementBundles      RequirementBundle[]
  portalClientAccesses    ClientPortalAccess[]

  @@map("tenants")
}

model TenantUser {
  id       Int    @id @default(autoincrement())
  tenantId Int
  userId   String
  roleId   Int

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id])

  @@unique([tenantId, userId])
  @@map("tenant_users")
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  permissions Permission[]
  tenantUsers TenantUser[]

  @@map("roles")
}

model Permission {
  id      Int     @id @default(autoincrement())
  roleId  Int
  module  String
  action  String
  allowed Boolean @default(true)

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, module, action])
  @@map("permissions")
}

// ============================================================================
// CLIENT MANAGEMENT
// ============================================================================

model Client {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  name      String
  type      String // individual/company/partnership
  email     String?
  phone     String?
  address   String?
  tin       String?
  nisNumber String?
  sector    String?
  riskLevel String? // low/medium/high
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businesses       ClientBusiness[]
  documents        Document[]
  filings          Filing[]
  serviceRequests  ServiceRequest[]
  complianceScores ComplianceScore[]
  tasks            Task[]
  clientTasks      ClientTask[]
  conversations    Conversation[]
  auditLogs        AuditLog[]
  recurringFilings RecurringFiling[]
  portalAccesses   ClientPortalAccess[]

  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, riskLevel])
  @@index([tenantId, sector])
  @@index([createdAt])
  @@map("clients")
}

model ClientPortalAccess {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  userId    String
  clientId  Int
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, clientId])
  @@index([tenantId, userId])
  @@index([tenantId, clientId])
  @@map("client_portal_access")
}

model ClientBusiness {
  id                 Int       @id @default(autoincrement())
  tenantId           Int
  clientId           Int
  name               String
  registrationNumber String?
  registrationType   String?
  incorporationDate  DateTime?
  country            String?
  sector             String?
  status             String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client           Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  documents        Document[]
  filings          Filing[]
  serviceRequests  ServiceRequest[]
  recurringFilings RecurringFiling[]

  @@index([tenantId])
  @@index([clientId])
  @@index([tenantId, clientId])
  @@index([status])
  @@map("client_businesses")
}

// ============================================================================
// DOCUMENT MANAGEMENT
// ============================================================================

model DocumentType {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String
  category    String
  description String?
  tags        String[]
  authority   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents              Document[]
  requirementBundleItems RequirementBundleItem[]

  @@unique([tenantId, name, category])
  @@index([tenantId])
  @@index([category])
  @@map("document_types")
}

model Document {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  clientBusinessId Int?
  documentTypeId   Int
  title            String
  description      String?
  status           String // valid, expired, pending_review, rejected
  authority        String?
  tags             String[]
  latestVersionId  Int?     @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client          Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientBusiness  ClientBusiness?   @relation(fields: [clientBusinessId], references: [id])
  documentType    DocumentType      @relation(fields: [documentTypeId], references: [id])
  versions        DocumentVersion[]
  latestVersion   DocumentVersion?  @relation("LatestDocumentVersion", fields: [latestVersionId], references: [id], onDelete: SetNull)
  filingDocuments FilingDocument[]

  @@index([tenantId])
  @@index([clientId])
  @@index([clientBusinessId])
  @@index([documentTypeId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, clientId])
  @@index([clientId, status])
  @@index([createdAt])
  @@map("documents")
}

model DocumentVersion {
  id               Int       @id @default(autoincrement())
  documentId       Int
  fileUrl          String
  storageProvider  String
  fileSize         Int?
  mimeType         String?
  issueDate        DateTime?
  expiryDate       DateTime?
  issuingAuthority String?
  ocrText          String?
  aiSummary        String?
  metadata         Json?
  uploadedById     String?
  uploadedAt       DateTime  @default(now())
  isLatest         Boolean   @default(false)

  document         Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  latestOfDocument Document? @relation("LatestDocumentVersion")

  @@index([documentId])
  @@index([expiryDate])
  @@index([isLatest])
  @@map("document_versions")
}

// ============================================================================
// FILING MANAGEMENT
// ============================================================================

model FilingType {
  id              Int      @id @default(autoincrement())
  tenantId        Int
  name            String
  code            String
  authority       String
  frequency       String // monthly/quarterly/annual/one_off
  defaultDueDay   Int?
  defaultDueMonth Int?
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  filings                Filing[]
  recurringFilings       RecurringFiling[]
  requirementBundleItems RequirementBundleItem[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([authority])
  @@index([frequency])
  @@map("filing_types")
}

model Filing {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  clientBusinessId Int?
  filingTypeId     Int
  periodStart      DateTime?
  periodEnd        DateTime?
  periodLabel      String?
  status           String // draft, prepared, submitted, approved, rejected, overdue, archived
  referenceNumber  String?
  taxAmount        Float?
  penalties        Float?
  interest         Float?
  total            Float?
  submissionDate   DateTime?
  approvalDate     DateTime?
  internalNotes    String?
  aiSummary        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientBusiness ClientBusiness?  @relation(fields: [clientBusinessId], references: [id])
  filingType     FilingType       @relation(fields: [filingTypeId], references: [id])
  documents      FilingDocument[]
  serviceSteps   ServiceStep[]
  tasks          Task[]

  @@index([tenantId])
  @@index([clientId])
  @@index([clientBusinessId])
  @@index([filingTypeId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, status, periodEnd])
  @@index([periodEnd])
  @@index([submissionDate])
  @@index([createdAt])
  @@map("filings")
}

model FilingDocument {
  id         Int @id @default(autoincrement())
  filingId   Int
  documentId Int

  filing   Filing   @relation(fields: [filingId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([filingId, documentId])
  @@index([filingId])
  @@index([documentId])
  @@map("filing_documents")
}

// ============================================================================
// SERVICE MANAGEMENT
// ============================================================================

model Service {
  id            Int      @id @default(autoincrement())
  tenantId      Int
  name          String
  category      String
  description   String?
  basePrice     Float?
  estimatedDays Int?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant          Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  serviceRequests ServiceRequest[]
  templates       ServiceRequestTemplate[]

  @@index([tenantId])
  @@index([tenantId, active])
  @@index([category])
  @@map("services")
}

model ServiceRequestTemplate {
  id              Int      @id @default(autoincrement())
  tenantId        Int
  serviceId       Int
  name            String
  description     String?
  stepsDefinition Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  service         Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceRequests ServiceRequest[]

  @@index([tenantId])
  @@index([serviceId])
  @@map("service_request_templates")
}

model ServiceRequest {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  clientBusinessId Int?
  serviceId        Int
  templateId       Int?
  status           String // new, in_progress, awaiting_client, awaiting_authority, completed, cancelled
  priority         String?
  currentStepOrder Int?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant         Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientBusiness ClientBusiness?         @relation(fields: [clientBusinessId], references: [id])
  service        Service                 @relation(fields: [serviceId], references: [id])
  template       ServiceRequestTemplate? @relation(fields: [templateId], references: [id])
  steps          ServiceStep[]
  tasks          Task[]
  clientTasks    ClientTask[]
  conversations  Conversation[]

  @@index([tenantId])
  @@index([clientId])
  @@index([clientBusinessId])
  @@index([serviceId])
  @@index([status])
  @@index([priority])
  @@index([tenantId, status])
  @@index([tenantId, clientId])
  @@index([createdAt])
  @@index([updatedAt])
  @@map("service_requests")
}

model ServiceStep {
  id                 Int       @id @default(autoincrement())
  serviceRequestId   Int
  filingId           Int?
  title              String
  description        String?
  order              Int
  status             String // not_started, in_progress, done, blocked
  dueDate            DateTime?
  requiredDocTypeIds Int[]
  dependsOnStepId    Int?

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  filing         Filing?        @relation(fields: [filingId], references: [id])

  @@index([serviceRequestId])
  @@index([filingId])
  @@index([status])
  @@index([serviceRequestId, order])
  @@map("service_steps")
}

model RecurringFiling {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  clientBusinessId Int?
  filingTypeId     Int
  schedule         String // cron-like or human-readable schedule
  active           Boolean   @default(true)
  lastRunAt        DateTime?
  nextRunAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientBusiness ClientBusiness? @relation(fields: [clientBusinessId], references: [id])
  filingType     FilingType      @relation(fields: [filingTypeId], references: [id])

  @@index([tenantId])
  @@index([clientId])
  @@index([clientBusinessId])
  @@index([filingTypeId])
  @@index([active])
  @@index([nextRunAt])
  @@index([tenantId, active, nextRunAt])
  @@map("recurring_filings")
}

// ============================================================================
// TASK MANAGEMENT
// ============================================================================

model Task {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int?
  serviceRequestId Int?
  filingId         Int?
  title            String
  description      String?
  status           String // open, in_progress, blocked, completed
  priority         String?
  dueDate          DateTime?
  assignedToId     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client?         @relation(fields: [clientId], references: [id])
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
  filing         Filing?         @relation(fields: [filingId], references: [id])
  assignedTo     User?           @relation("TaskAssignee", fields: [assignedToId], references: [id])

  @@index([tenantId])
  @@index([clientId])
  @@index([serviceRequestId])
  @@index([filingId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([tenantId, status])
  @@index([tenantId, assignedToId])
  @@index([tenantId, assignedToId, status])
  @@index([assignedToId, status, dueDate])
  @@index([tenantId, status, dueDate])
  @@index([updatedAt])
  @@map("tasks")
}

model ClientTask {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  serviceRequestId Int?
  title            String
  description      String?
  status           String // pending, in_progress, completed, cancelled
  dueDate          DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id])

  @@index([tenantId])
  @@index([clientId])
  @@index([serviceRequestId])
  @@index([status])
  @@index([dueDate])
  @@index([tenantId, clientId])
  @@index([tenantId, status])
  @@map("client_tasks")
}

// ============================================================================
// COMMUNICATION
// ============================================================================

model Conversation {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  clientId         Int?
  serviceRequestId Int?
  subject          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client?         @relation(fields: [clientId], references: [id])
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
  messages       Message[]

  @@index([tenantId])
  @@index([clientId])
  @@index([serviceRequestId])
  @@index([createdAt])
  @@map("conversations")
}

model Message {
  id             Int       @id @default(autoincrement())
  conversationId Int
  authorId       String
  body           String
  createdAt      DateTime  @default(now())
  readAt         DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  author       User         @relation("MessageAuthor", fields: [authorId], references: [id])

  @@index([conversationId])
  @@index([authorId])
  @@index([createdAt])
  @@index([conversationId, createdAt])
  @@map("messages")
}

// ============================================================================
// COMPLIANCE ENGINE
// ============================================================================

model ComplianceRuleSet {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  name      String
  appliesTo Json?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rules  ComplianceRule[]

  @@index([tenantId])
  @@index([tenantId, active])
  @@map("compliance_rule_sets")
}

model ComplianceRule {
  id          Int     @id @default(autoincrement())
  ruleSetId   Int
  ruleType    String // document_required, filing_required, etc.
  condition   Json?
  targetId    Int?
  weight      Float
  description String?

  ruleSet ComplianceRuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@index([ruleSetId])
  @@index([ruleType])
  @@map("compliance_rules")
}

model ComplianceScore {
  id                  Int      @id @default(autoincrement())
  tenantId            Int
  clientId            Int
  scoreValue          Float
  level               String
  missingCount        Int
  expiringCount       Int
  overdueFilingsCount Int
  lastCalculatedAt    DateTime
  breakdown           Json?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([tenantId, clientId])
  @@index([tenantId])
  @@index([clientId])
  @@index([level])
  @@index([scoreValue])
  @@index([lastCalculatedAt])
  @@index([tenantId, level])
  @@index([tenantId, lastCalculatedAt])
  @@map("compliance_scores")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id              Int      @id @default(autoincrement())
  tenantId        Int
  recipientUserId String
  type            String // email, in_app, sms
  channelStatus   String // pending, sent, failed
  message         String
  metadata        Json?
  createdAt       DateTime @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recipient User   @relation("NotificationRecipient", fields: [recipientUserId], references: [id])

  @@index([tenantId])
  @@index([recipientUserId])
  @@index([type])
  @@index([channelStatus])
  @@index([createdAt])
  @@index([tenantId, recipientUserId])
  @@index([recipientUserId, channelStatus])
  @@map("notifications")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  actorUserId String?
  clientId    Int?
  entityType  String
  entityId    Int
  action      String
  changes     Json?
  createdAt   DateTime @default(now())
  ipAddress   String?
  userAgent   String?

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?   @relation("AuditActor", fields: [actorUserId], references: [id])
  client Client? @relation(fields: [clientId], references: [id])

  @@index([tenantId])
  @@index([actorUserId])
  @@index([clientId])
  @@index([entityType])
  @@index([action])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([tenantId, actorUserId])
  @@index([tenantId, entityType])
  @@map("audit_logs")
}

// ============================================================================
// SUBSCRIPTION & PLANS
// ============================================================================

model Plan {
  id           Int     @id @default(autoincrement())
  name         String
  description  String?
  monthlyPrice Float?
  yearlyPrice  Float?
  limits       Json?

  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id          Int       @id @default(autoincrement())
  tenantId    Int
  planId      Int
  status      String
  startDate   DateTime
  endDate     DateTime?
  renewalDate DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id])

  @@index([tenantId])
  @@index([planId])
  @@index([status])
  @@index([renewalDate])
  @@map("subscriptions")
}

// ============================================================================
// REQUIREMENT BUNDLES
// ============================================================================

model RequirementBundle {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String
  authority   String // GRA, NIS, DCRA, Immigration, Deeds, GO-Invest
  category    String // tax, registration, permit, etc.
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  RequirementBundleItem[]

  @@index([tenantId])
  @@index([authority])
  @@index([category])
  @@index([tenantId, authority])
  @@map("requirement_bundles")
}

model RequirementBundleItem {
  id             Int      @id @default(autoincrement())
  bundleId       Int
  documentTypeId Int?
  filingTypeId   Int?
  required       Boolean  @default(true)
  description    String?
  order          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  bundle       RequirementBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  documentType DocumentType?     @relation(fields: [documentTypeId], references: [id])
  filingType   FilingType?       @relation(fields: [filingTypeId], references: [id])

  @@index([bundleId])
  @@index([documentTypeId])
  @@index([filingTypeId])
  @@index([bundleId, order])
  @@map("requirement_bundle_items")
}
