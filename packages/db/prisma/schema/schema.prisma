// Prisma schema for GCMC-KAJ â€“ Multi-tenant SaaS Platform with Better-Auth
// Merged schema: Better-Auth authentication + Multi-tenant business logic

generator client {
  provider     = "prisma-client-js"
  output       = "../generated"
  moduleFormat = "esm"
  runtime      = "bun"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION (Better-Auth Models)
// ============================================================================

model User {
  id            String   @id @default(cuid()) @map("_id")
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  phone         String?
  avatarUrl     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions             Session[]
  accounts             Account[]
  tenantUsers          TenantUser[]
  portalClientAccesses ClientPortalAccess[]
  messages             Message[]            @relation("MessageAuthor")
  tasks                Task[]               @relation("TaskAssignee")
  notifications        Notification[]       @relation("NotificationRecipient")
  auditLogs            AuditLog[]           @relation("AuditActor")
  // Enhanced Agency System Relations
  agencyDeadlinesAssigned AgencyDeadline[]
  complianceAlertsAcknowledged ComplianceAlert[]
  submissionsSubmitted AgencySubmission[]   @relation("SubmissionSubmitter")
  submissionsProcessed AgencySubmission[]   @relation("SubmissionProcessor")
  submissionEventsActed SubmissionEvent[]   @relation("EventActor")
  migrationProgressLogs MigrationProgressLog[]

  @@index([email])
  @@index([createdAt])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid()) @map("_id")
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid()) @map("_id")
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@index([providerId])
  @@index([accountId])
  @@map("account")
}

model Verification {
  id         String    @id @default(cuid()) @map("_id")
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@index([identifier, value])
  @@index([expiresAt])
  @@map("verification")
}

// ============================================================================
// MULTI-TENANT CORE
// ============================================================================

model Tenant {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   @unique
  contactInfo Json?
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantUsers             TenantUser[]
  roles                   Role[]
  clients                 Client[]
  clientBusinesses        ClientBusiness[]
  documentTypes           DocumentType[]
  filingTypes             FilingType[]
  services                Service[]
  recurringFilings        RecurringFiling[]
  notifications           Notification[]
  auditLogs               AuditLog[]
  subscriptions           Subscription[]
  complianceRuleSets      ComplianceRuleSet[]
  conversations           Conversation[]
  tasks                   Task[]
  clientTasks             ClientTask[]
  serviceRequestTemplates ServiceRequestTemplate[]
  serviceRequests         ServiceRequest[]
  filings                 Filing[]
  documents               Document[]
  complianceScores        ComplianceScore[]
  requirementBundles      RequirementBundle[]
  portalClientAccesses    ClientPortalAccess[]
  generatedReports        GeneratedReport[]
  // Enhanced Agency System
  agencyInfos             AgencyInfo[]
  agencyDocumentRequirements AgencyDocumentRequirement[]
  agencyComplianceStatuses AgencyComplianceStatus[]
  agencyDeadlines         AgencyDeadline[]
  agencyOverdueItems      AgencyOverdueItem[]
  complianceAlerts        ComplianceAlert[]
  documentWorkflows       DocumentWorkflow[]
  workflowExecutions      WorkflowExecution[]
  agencyFormTemplates     AgencyFormTemplate[]
  agencySubmissions        AgencySubmission[]
  agencyIntegrationConfigs AgencyIntegrationConfig[]
  servicePackages         ServicePackage[]
  clientServiceSubscriptions ClientServiceSubscription[]
  clientTypeTemplates     ClientTypeTemplate[]
  // Enhanced migration system relations
  documentMigrationProjects DocumentMigrationProject[]
  physicalDocumentRecords PhysicalDocumentRecord[]
  documentMigrationTasks DocumentMigrationTask[]
  migrationProgressLogs  MigrationProgressLog[]
  documentSyncStatuses   DocumentSyncStatus[]
  legacyDataImportJobs   LegacyDataImportJob[]
  legacyDataImportRecords LegacyDataImportRecord[]
  transitionWorkflowTemplates TransitionWorkflowTemplate[]
  transitionWorkflowExecutions TransitionWorkflowExecution[]

  @@map("tenants")
}

model TenantUser {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  userId    String
  roleId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([tenantId, userId])
  @@index([userId])
  @@index([tenantId])
  @@index([roleId])
  @@map("tenant_users")
}

model Role {
  id          Int          @id @default(autoincrement())
  tenantId    Int
  name        String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  permissions Permission[]
  tenantUsers TenantUser[]

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id        Int      @id @default(autoincrement())
  roleId    Int
  module    String
  action    String
  allowed   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, module, action])
  @@index([roleId])
  @@index([roleId, module])
  @@map("permissions")
}

// ============================================================================
// CLIENT MANAGEMENT
// ============================================================================

model Client {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  name      String
  type      String // individual/company/partnership
  email     String?
  phone     String?
  address   String?
  tin       String?
  nisNumber String?
  sector    String?
  riskLevel String? // low/medium/high
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant           Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businesses       ClientBusiness[]
  documents        Document[]
  filings          Filing[]
  serviceRequests  ServiceRequest[]
  complianceScores ComplianceScore[]
  tasks            Task[]
  clientTasks      ClientTask[]
  conversations    Conversation[]
  auditLogs        AuditLog[]
  recurringFilings RecurringFiling[]
  portalAccesses   ClientPortalAccess[]
  generatedReports GeneratedReport[]
  // Enhanced Agency System Relations
  agencyComplianceStatuses AgencyComplianceStatus[]
  agencyDeadlines         AgencyDeadline[]
  agencyOverdueItems      AgencyOverdueItem[]
  complianceAlerts        ComplianceAlert[]
  agencySubmissions       AgencySubmission[]
  workflowExecutions      WorkflowExecution[]
  serviceSubscriptions    ClientServiceSubscription[]
  // Enhanced migration system relations
  documentMigrationProjects DocumentMigrationProject[]
  physicalDocumentRecords PhysicalDocumentRecord[]
  transitionWorkflowExecutions TransitionWorkflowExecution[]

  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, riskLevel])
  @@index([tenantId, sector])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@map("clients")
}

model ClientPortalAccess {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  userId    String
  clientId  Int
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, clientId])
  @@index([tenantId, userId])
  @@index([tenantId, clientId])
  @@map("client_portal_access")
}

model ClientBusiness {
  id                 Int       @id @default(autoincrement())
  tenantId           Int
  clientId           Int
  name               String
  registrationNumber String?
  registrationType   String?
  incorporationDate  DateTime?
  country            String?
  sector             String?
  status             String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client           Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  documents        Document[]
  filings          Filing[]
  serviceRequests  ServiceRequest[]
  recurringFilings RecurringFiling[]

  @@index([tenantId])
  @@index([clientId])
  @@index([tenantId, clientId])
  @@index([status])
  @@map("client_businesses")
}

// ============================================================================
// DOCUMENT MANAGEMENT
// ============================================================================

model DocumentType {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String
  category    String
  description String?
  tags        String[]
  authority   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents              Document[]
  requirementBundleItems RequirementBundleItem[]

  @@unique([tenantId, name, category])
  @@index([tenantId])
  @@index([category])
  @@map("document_types")
}

model Document {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  clientBusinessId Int?
  documentTypeId   Int
  title            String
  description      String?
  status           String // valid, expired, pending_review, rejected
  authority        String?
  tags             String[]
  latestVersionId  Int?     @unique

  // Enhanced migration tracking
  sourceType              String?   @default("digital") // physical, digital, scanned, imported
  physicalLocation        String?   // Original physical location if scanned
  migrationDate           DateTime? // When this was digitized/migrated
  migrationQualityScore   Float?    // Quality score from migration process
  migrationNotes          String?   // Notes from migration process

  // OCR and AI enhancements
  ocrConfidenceScore      Float?    // Overall OCR confidence
  aiClassification        Json?     // AI-powered document classification results
  extractedEntities       Json?     // Named entities extracted from document
  complianceFlags         Json?     // GRA/NIS compliance markers

  // Version control enhancements
  isLatestPhysicalVersion Boolean   @default(true)
  physicalVersionNotes    String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client          Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientBusiness  ClientBusiness?   @relation(fields: [clientBusinessId], references: [id], onDelete: SetNull)
  documentType    DocumentType      @relation(fields: [documentTypeId], references: [id], onDelete: Restrict)
  versions        DocumentVersion[]
  latestVersion   DocumentVersion?  @relation("LatestDocumentVersion", fields: [latestVersionId], references: [id], onDelete: SetNull)
  filingDocuments FilingDocument[]
  // Enhanced Agency System Relations
  agencyRequirementStatuses AgencyRequirementStatus[]
  workflowExecutions       WorkflowExecution[]
  // Migration tracking relations
  physicalRecords         PhysicalDocumentRecord[]
  syncStatus              DocumentSyncStatus[]

  @@index([tenantId])
  @@index([clientId])
  @@index([clientBusinessId])
  @@index([documentTypeId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, clientId])
  @@index([clientId, status])
  @@index([createdAt])
  @@index([tenantId, documentTypeId, status])
  @@index([sourceType]) // New index for migration tracking
  @@index([migrationDate]) // New index for migration queries
  @@map("documents")
}

model DocumentVersion {
  id               Int       @id @default(autoincrement())
  documentId       Int
  fileUrl          String
  storageProvider  String
  fileSize         Int?
  mimeType         String?
  issueDate        DateTime?
  expiryDate       DateTime?
  issuingAuthority String?
  ocrText          String?
  aiSummary        String?
  metadata         Json?
  uploadedById     String?
  uploadedAt       DateTime  @default(now())
  isLatest         Boolean   @default(false)

  document         Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  latestOfDocument Document? @relation("LatestDocumentVersion")

  @@index([documentId])
  @@index([documentId, isLatest])
  @@index([documentId, uploadedAt])
  @@index([expiryDate])
  @@index([isLatest])
  @@map("document_versions")
}

// ============================================================================
// FILING MANAGEMENT
// ============================================================================

model FilingType {
  id              Int      @id @default(autoincrement())
  tenantId        Int
  name            String
  code            String
  authority       String
  frequency       String // monthly/quarterly/annual/one_off
  defaultDueDay   Int?
  defaultDueMonth Int?
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  filings                Filing[]
  recurringFilings       RecurringFiling[]
  requirementBundleItems RequirementBundleItem[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([authority])
  @@index([frequency])
  @@map("filing_types")
}

model Filing {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  clientBusinessId Int?
  filingTypeId     Int
  periodStart      DateTime?
  periodEnd        DateTime?
  periodLabel      String?
  status           String // draft, prepared, submitted, approved, rejected, overdue, archived
  referenceNumber  String?
  taxAmount        Float?
  penalties        Float?
  interest         Float?
  total            Float?
  submissionDate   DateTime?
  approvalDate     DateTime?
  internalNotes    String?
  aiSummary        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientBusiness ClientBusiness?  @relation(fields: [clientBusinessId], references: [id], onDelete: SetNull)
  filingType     FilingType       @relation(fields: [filingTypeId], references: [id], onDelete: Restrict)
  documents      FilingDocument[]
  serviceSteps   ServiceStep[]
  tasks          Task[]

  @@index([tenantId])
  @@index([clientId])
  @@index([clientBusinessId])
  @@index([filingTypeId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, status, periodEnd])
  @@index([periodEnd])
  @@index([submissionDate])
  @@index([createdAt])
  @@index([clientId, filingTypeId, status])
  @@index([status, periodEnd])
  @@map("filings")
}

model FilingDocument {
  id         Int      @id @default(autoincrement())
  filingId   Int
  documentId Int
  createdAt  DateTime @default(now())

  filing   Filing   @relation(fields: [filingId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([filingId, documentId])
  @@index([filingId])
  @@index([documentId])
  @@map("filing_documents")
}

// ============================================================================
// REPORT GENERATION & ARCHIVAL
// ============================================================================

model GeneratedReport {
  id            Int      @id @default(autoincrement())
  tenantId      Int
  clientId      Int
  reportType    String   // client_file, compliance, documents_list, filings_summary, service_history
  filePath      String   // MinIO path to stored PDF
  fileName      String   // Original filename for downloads
  fileSize      Int      // File size in bytes
  checksum      String   // SHA256 checksum for integrity
  generatedBy   String   // User ID who generated the report
  generatedAt   DateTime // When the report was generated
  expiresAt     DateTime // When the report should be deleted (retention policy)
  downloadedAt  DateTime? // Last download timestamp
  downloadCount Int      @default(0) // Number of times downloaded
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tenantId, clientId])
  @@index([tenantId, reportType])
  @@index([generatedAt])
  @@index([expiresAt])
  @@map("generated_reports")
}

// ============================================================================
// SERVICE MANAGEMENT
// ============================================================================

model Service {
  id            Int      @id @default(autoincrement())
  tenantId      Int
  name          String
  category      String
  description   String?
  basePrice     Float?
  estimatedDays Int?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant          Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  serviceRequests ServiceRequest[]
  templates       ServiceRequestTemplate[]

  @@index([tenantId])
  @@index([tenantId, active])
  @@index([category])
  @@map("services")
}

model ServiceRequestTemplate {
  id              Int      @id @default(autoincrement())
  tenantId        Int
  serviceId       Int
  name            String
  description     String?
  stepsDefinition Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  service         Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceRequests ServiceRequest[]

  @@index([tenantId])
  @@index([serviceId])
  @@map("service_request_templates")
}

model ServiceRequest {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  clientBusinessId Int?
  serviceId        Int
  templateId       Int?
  status           String // new, in_progress, awaiting_client, awaiting_authority, completed, cancelled
  priority         String?
  currentStepOrder Int?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant         Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientBusiness ClientBusiness?         @relation(fields: [clientBusinessId], references: [id], onDelete: SetNull)
  service        Service                 @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  template       ServiceRequestTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  steps          ServiceStep[]
  tasks          Task[]
  clientTasks    ClientTask[]
  conversations  Conversation[]

  @@index([tenantId])
  @@index([clientId])
  @@index([clientBusinessId])
  @@index([serviceId])
  @@index([status])
  @@index([priority])
  @@index([tenantId, status])
  @@index([tenantId, clientId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([tenantId, clientId, status])
  @@index([tenantId, status, createdAt])
  @@index([serviceId, status])
  @@map("service_requests")
}

model ServiceStep {
  id                 Int       @id @default(autoincrement())
  serviceRequestId   Int
  filingId           Int?
  title              String
  description        String?
  order              Int
  status             String // not_started, in_progress, done, blocked
  dueDate            DateTime?
  requiredDocTypeIds Int[]
  dependsOnStepId    Int?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  filing         Filing?        @relation(fields: [filingId], references: [id], onDelete: SetNull)
  dependsOnStep  ServiceStep?   @relation("StepDependency", fields: [dependsOnStepId], references: [id], onDelete: SetNull)
  dependentSteps ServiceStep[]  @relation("StepDependency")

  @@index([serviceRequestId])
  @@index([filingId])
  @@index([status])
  @@index([dueDate])
  @@index([dependsOnStepId])
  @@index([serviceRequestId, order])
  @@index([serviceRequestId, status, order])
  @@map("service_steps")
}

model RecurringFiling {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  clientBusinessId Int?
  filingTypeId     Int
  schedule         String // cron-like or human-readable schedule
  active           Boolean   @default(true)
  lastRunAt        DateTime?
  nextRunAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientBusiness ClientBusiness? @relation(fields: [clientBusinessId], references: [id], onDelete: SetNull)
  filingType     FilingType      @relation(fields: [filingTypeId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([clientId])
  @@index([clientBusinessId])
  @@index([filingTypeId])
  @@index([active])
  @@index([nextRunAt])
  @@index([tenantId, active, nextRunAt])
  @@map("recurring_filings")
}

// ============================================================================
// TASK MANAGEMENT
// ============================================================================

model Task {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int?
  serviceRequestId Int?
  filingId         Int?
  title            String
  description      String?
  status           String // open, in_progress, blocked, completed
  priority         String?
  dueDate          DateTime?
  assignedToId     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client?         @relation(fields: [clientId], references: [id], onDelete: SetNull)
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id], onDelete: SetNull)
  filing         Filing?         @relation(fields: [filingId], references: [id], onDelete: SetNull)
  assignedTo     User?           @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientId])
  @@index([serviceRequestId])
  @@index([filingId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([tenantId, status])
  @@index([tenantId, assignedToId])
  @@index([tenantId, assignedToId, status])
  @@index([assignedToId, status, dueDate])
  @@index([tenantId, status, dueDate])
  @@index([updatedAt])
  @@index([tenantId, clientId, status])
  @@index([dueDate, status])
  @@map("tasks")
}

model ClientTask {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  serviceRequestId Int?
  title            String
  description      String?
  status           String // pending, in_progress, completed, cancelled
  dueDate          DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientId])
  @@index([serviceRequestId])
  @@index([status])
  @@index([dueDate])
  @@index([tenantId, clientId])
  @@index([tenantId, status])
  @@map("client_tasks")
}

// ============================================================================
// COMMUNICATION
// ============================================================================

model Conversation {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  clientId         Int?
  serviceRequestId Int?
  subject          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client?         @relation(fields: [clientId], references: [id], onDelete: SetNull)
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id], onDelete: SetNull)
  messages       Message[]

  @@index([tenantId])
  @@index([clientId])
  @@index([serviceRequestId])
  @@index([createdAt])
  @@map("conversations")
}

model Message {
  id             Int       @id @default(autoincrement())
  tenantId       Int
  conversationId Int
  authorId       String
  body           String
  createdAt      DateTime  @default(now())
  readAt         DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  author       User         @relation("MessageAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([conversationId])
  @@index([authorId])
  @@index([createdAt])
  @@index([conversationId, createdAt])
  @@index([conversationId, readAt])
  @@map("messages")
}

// ============================================================================
// COMPLIANCE ENGINE
// ============================================================================

model ComplianceRuleSet {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  name      String
  appliesTo Json?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rules  ComplianceRule[]

  @@index([tenantId])
  @@index([tenantId, active])
  @@map("compliance_rule_sets")
}

model ComplianceRule {
  id          Int      @id @default(autoincrement())
  ruleSetId   Int
  ruleType    String // document_required, filing_required, etc.
  condition   Json?
  targetId    Int?
  weight      Float
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ruleSet ComplianceRuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@index([ruleSetId])
  @@index([ruleType])
  @@index([ruleSetId, ruleType])
  @@map("compliance_rules")
}

model ComplianceScore {
  id                  Int      @id @default(autoincrement())
  tenantId            Int
  clientId            Int
  scoreValue          Float
  level               String
  missingCount        Int
  expiringCount       Int
  overdueFilingsCount Int
  lastCalculatedAt    DateTime
  breakdown           Json?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([tenantId, clientId])
  @@index([tenantId])
  @@index([clientId])
  @@index([level])
  @@index([scoreValue])
  @@index([lastCalculatedAt])
  @@index([tenantId, level])
  @@index([tenantId, lastCalculatedAt])
  @@map("compliance_scores")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id              Int      @id @default(autoincrement())
  tenantId        Int
  recipientUserId String
  type            String // email, in_app, sms
  channelStatus   String // pending, sent, failed
  message         String
  metadata        Json?
  createdAt       DateTime @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recipient User   @relation("NotificationRecipient", fields: [recipientUserId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([recipientUserId])
  @@index([type])
  @@index([channelStatus])
  @@index([createdAt])
  @@index([tenantId, recipientUserId])
  @@index([recipientUserId, channelStatus])
  @@map("notifications")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  actorUserId String?
  clientId    Int?
  entityType  String
  entityId    Int
  action      String
  changes     Json?
  createdAt   DateTime @default(now())
  ipAddress   String?
  userAgent   String?

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?   @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  client Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([actorUserId])
  @@index([clientId])
  @@index([entityType])
  @@index([action])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([tenantId, actorUserId])
  @@index([tenantId, entityType])
  @@index([tenantId, action, createdAt])
  @@index([actorUserId, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// ============================================================================
// SUBSCRIPTION & PLANS
// ============================================================================

model Plan {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  monthlyPrice Float?
  yearlyPrice  Float?
  limits       Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  subscriptions Subscription[]

  @@index([name])
  @@map("plans")
}

model Subscription {
  id          Int       @id @default(autoincrement())
  tenantId    Int
  planId      Int
  status      String
  startDate   DateTime
  endDate     DateTime?
  renewalDate DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([planId])
  @@index([status])
  @@index([renewalDate])
  @@index([tenantId, status])
  @@index([tenantId, renewalDate])
  @@map("subscriptions")
}

// ============================================================================
// REQUIREMENT BUNDLES
// ============================================================================

model RequirementBundle {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String
  authority   String // GRA, NIS, DCRA, Immigration, Deeds, GO-Invest
  category    String // tax, registration, permit, etc.
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  RequirementBundleItem[]

  @@index([tenantId])
  @@index([authority])
  @@index([category])
  @@index([tenantId, authority])
  @@map("requirement_bundles")
}

model RequirementBundleItem {
  id             Int      @id @default(autoincrement())
  bundleId       Int
  documentTypeId Int?
  filingTypeId   Int?
  required       Boolean  @default(true)
  description    String?
  order          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  bundle       RequirementBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  documentType DocumentType?     @relation(fields: [documentTypeId], references: [id], onDelete: Restrict)
  filingType   FilingType?       @relation(fields: [filingTypeId], references: [id], onDelete: Restrict)

  @@index([bundleId])
  @@index([documentTypeId])
  @@index([filingTypeId])
  @@index([bundleId, order])
  @@map("requirement_bundle_items")
}

// ============================================================================
// ENHANCED GUYANESE REGULATORY AGENCY SYSTEM
// ============================================================================

model AgencyInfo {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  code         String   // Authority enum value
  name         String
  fullName     String
  category     String   // AgencyCategory enum
  description  String
  website      String?
  contactInfo  Json?    // Phone, email, address, hours
  onlinePortal Json?    // URL, loginRequired, supportedServices
  isActive     Boolean  @default(true)
  priority     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant                  Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documentRequirements    AgencyDocumentRequirement[]
  complianceStatuses      AgencyComplianceStatus[]
  deadlines              AgencyDeadline[]
  overdueItems           AgencyOverdueItem[]
  alerts                 ComplianceAlert[]
  submissions            AgencySubmission[]
  workflows              DocumentWorkflow[]
  formTemplates          AgencyFormTemplate[]
  integrationConfigs     AgencyIntegrationConfig[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([category])
  @@index([isActive])
  @@index([priority])
  @@map("agency_info")
}

model AgencyDocumentRequirement {
  id                   Int       @id @default(autoincrement())
  tenantId             Int
  agencyInfoId         Int
  authority            String    // Authority enum
  documentType         String
  category             String    // DocumentCategory enum
  name                 String
  description          String
  isRequired           Boolean   @default(true)
  frequency            String?   // FilingFrequency enum
  dueDateConfig        Json?     // Day of month, month of year, days after event
  validityPeriod       Json?     // Duration and unit
  reminderSchedule     Json?     // Advance, unit, escalation
  penalties            Json?     // Late filing fee, daily penalty, max penalty
  submissionMethods    String[]  // online, physical, email, postal
  supportingDocuments  String[]
  applicableClientTypes String[] // ClientType enum values
  metadata             Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  tenant               Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agencyInfo           AgencyInfo                    @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)
  validationRules      DocumentValidationRule[]
  requirementStatuses  AgencyRequirementStatus[]
  deadlines           AgencyDeadline[]
  overdueItems        AgencyOverdueItem[]

  @@index([tenantId])
  @@index([agencyInfoId])
  @@index([authority])
  @@index([documentType])
  @@index([category])
  @@index([isRequired])
  @@index([frequency])
  @@index([tenantId, authority])
  @@index([authority, documentType])
  @@map("agency_document_requirements")
}

model DocumentValidationRule {
  id                Int      @id @default(autoincrement())
  requirementId     Int
  name              String
  ruleType          String   // required_field, format, size, date_range, calculation, cross_reference
  field             String?
  conditions        Json     // Operator, value, min, max, pattern
  errorMessage      String
  severity          String   // error, warning, info
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  requirement AgencyDocumentRequirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)

  @@index([requirementId])
  @@index([ruleType])
  @@index([isActive])
  @@map("document_validation_rules")
}

model AgencyComplianceStatus {
  id               Int      @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  agencyInfoId     Int
  authority        String   // Authority enum
  overallStatus    String   // ComplianceLevel enum
  score            Float
  lastAssessment   DateTime
  recommendations  String[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant               Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client               Client                    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  agencyInfo           AgencyInfo                @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)
  requirementStatuses  AgencyRequirementStatus[]

  @@unique([tenantId, clientId, agencyInfoId])
  @@index([tenantId])
  @@index([clientId])
  @@index([agencyInfoId])
  @@index([authority])
  @@index([overallStatus])
  @@index([score])
  @@index([lastAssessment])
  @@index([tenantId, authority])
  @@index([clientId, overallStatus])
  @@map("agency_compliance_status")
}

model AgencyRequirementStatus {
  id              Int       @id @default(autoincrement())
  complianceId    Int
  requirementId   Int
  documentType    String
  status          String    // compliant, non_compliant, pending, not_applicable
  lastSubmission  DateTime?
  nextDue         DateTime?
  documentId      Int?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  compliance  AgencyComplianceStatus      @relation(fields: [complianceId], references: [id], onDelete: Cascade)
  requirement AgencyDocumentRequirement   @relation(fields: [requirementId], references: [id], onDelete: Restrict)
  document    Document?                   @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([complianceId])
  @@index([requirementId])
  @@index([documentId])
  @@index([status])
  @@index([nextDue])
  @@index([lastSubmission])
  @@index([complianceId, status])
  @@map("agency_requirement_status")
}

model AgencyDeadline {
  id                      Int       @id @default(autoincrement())
  tenantId                Int
  clientId                Int
  agencyInfoId            Int
  requirementId           Int
  authority               String    // Authority enum
  documentType            String
  description             String
  dueDate                 DateTime
  priority                String    // TaskPriority enum
  status                  String    // upcoming, due_today, overdue
  reminderSent            DateTime?
  escalationLevel         Int       @default(0)
  estimatedCompletionTime Int?      // in hours
  assignedToId            String?
  dependencies            String[]
  metadata                Json?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  tenant      Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client      Client                    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  agencyInfo  AgencyInfo                @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)
  requirement AgencyDocumentRequirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  assignedTo  User?                     @relation(fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientId])
  @@index([agencyInfoId])
  @@index([requirementId])
  @@index([authority])
  @@index([dueDate])
  @@index([priority])
  @@index([status])
  @@index([assignedToId])
  @@index([escalationLevel])
  @@index([tenantId, status])
  @@index([clientId, dueDate])
  @@index([authority, dueDate])
  @@index([dueDate, status])
  @@index([tenantId, authority, status])
  @@map("agency_deadlines")
}

model AgencyOverdueItem {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  agencyInfoId     Int
  requirementId    Int
  authority        String    // Authority enum
  documentType     String
  description      String
  originalDueDate  DateTime
  daysOverdue      Int
  accruedPenalties Float     @default(0)
  maxPenalty       Float?
  status           String    // overdue, penalty_accruing, escalated
  notificationsSent Int      @default(0)
  lastNotification DateTime?
  escalationPath   String[]
  metadata         Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant      Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client      Client                    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  agencyInfo  AgencyInfo                @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)
  requirement AgencyDocumentRequirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clientId])
  @@index([agencyInfoId])
  @@index([requirementId])
  @@index([authority])
  @@index([status])
  @@index([daysOverdue])
  @@index([accruedPenalties])
  @@index([originalDueDate])
  @@index([tenantId, status])
  @@index([clientId, authority])
  @@index([authority, status])
  @@map("agency_overdue_items")
}

model ComplianceAlert {
  id              Int       @id @default(autoincrement())
  tenantId        Int
  clientId        Int
  agencyInfoId    Int
  authority       String    // Authority enum
  type            String    // deadline_approaching, document_expired, penalty_accruing, etc.
  severity        String    // low, medium, high, critical
  title           String
  message         String
  actionRequired  String?
  dueDate         DateTime?
  acknowledged    Boolean   @default(false)
  acknowledgedBy  String?
  acknowledgedAt  DateTime?
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  agencyInfo     AgencyInfo @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)
  acknowledgedByUser User?   @relation(fields: [acknowledgedBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientId])
  @@index([agencyInfoId])
  @@index([authority])
  @@index([type])
  @@index([severity])
  @@index([acknowledged])
  @@index([dueDate])
  @@index([createdAt])
  @@index([tenantId, acknowledged])
  @@index([clientId, severity])
  @@index([authority, type])
  @@map("compliance_alerts")
}

model DocumentWorkflow {
  id           Int      @id @default(autoincrement())
  tenantId     Int
  agencyInfoId Int
  authority    String   // Authority enum
  documentType String
  name         String
  description  String
  version      String
  isActive     Boolean  @default(true)
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agencyInfo    AgencyInfo     @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)
  steps         WorkflowStep[]
  triggers      WorkflowTrigger[]
  executions    WorkflowExecution[]

  @@index([tenantId])
  @@index([agencyInfoId])
  @@index([authority])
  @@index([documentType])
  @@index([isActive])
  @@index([tenantId, authority])
  @@index([authority, documentType])
  @@map("document_workflows")
}

model WorkflowStep {
  id          Int      @id @default(autoincrement())
  workflowId  Int
  order       Int
  name        String
  description String
  type        String   // validation, approval, notification, submission, wait, condition
  config      Json     // assignedRole, timeoutHours, autoComplete, conditions, actions
  dependencies String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workflow   DocumentWorkflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  executions WorkflowStepExecution[]

  @@index([workflowId])
  @@index([order])
  @@index([type])
  @@index([isActive])
  @@index([workflowId, order])
  @@map("workflow_steps")
}

model WorkflowTrigger {
  id          Int      @id @default(autoincrement())
  workflowId  Int
  type        String   // document_upload, date_based, status_change, manual, api_call
  conditions  Json     // Field, operator, value, logicalOperator
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workflow DocumentWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([type])
  @@index([isActive])
  @@map("workflow_triggers")
}

model WorkflowExecution {
  id           Int       @id @default(autoincrement())
  tenantId     Int
  workflowId   Int
  clientId     Int?
  documentId   Int?
  submissionId Int?
  status       String    // started, in_progress, completed, failed, cancelled
  startedAt    DateTime
  completedAt  DateTime?
  failedAt     DateTime?
  errorMessage String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant     Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflow   DocumentWorkflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  client     Client?              @relation(fields: [clientId], references: [id], onDelete: SetNull)
  document   Document?            @relation(fields: [documentId], references: [id], onDelete: SetNull)
  submission AgencySubmission?    @relation(fields: [submissionId], references: [id], onDelete: SetNull)
  stepExecutions WorkflowStepExecution[]

  @@index([tenantId])
  @@index([workflowId])
  @@index([clientId])
  @@index([documentId])
  @@index([submissionId])
  @@index([status])
  @@index([startedAt])
  @@index([completedAt])
  @@index([tenantId, status])
  @@index([workflowId, status])
  @@map("workflow_executions")
}

model WorkflowStepExecution {
  id          Int       @id @default(autoincrement())
  executionId Int
  stepId      Int
  status      String    // pending, in_progress, completed, failed, skipped
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?
  errorMessage String?
  output      Json?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  execution WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  step      WorkflowStep      @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([stepId])
  @@index([status])
  @@index([executionId, status])
  @@map("workflow_step_executions")
}

model AgencyFormTemplate {
  id              Int      @id @default(autoincrement())
  tenantId        Int
  agencyInfoId    Int
  authority       String   // Authority enum
  documentType    String
  name            String
  version         String
  description     String?
  submissionConfig Json    // method, endpoint, format, authentication
  isActive        Boolean  @default(true)
  effectiveDate   DateTime
  expiryDate      DateTime?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant         Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agencyInfo     AgencyInfo          @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)
  sections       FormSection[]
  validationRules FormValidationRule[]
  submissions    AgencySubmission[]

  @@index([tenantId])
  @@index([agencyInfoId])
  @@index([authority])
  @@index([documentType])
  @@index([isActive])
  @@index([effectiveDate])
  @@index([expiryDate])
  @@index([tenantId, authority])
  @@index([authority, documentType])
  @@map("agency_form_templates")
}

model FormSection {
  id           Int      @id @default(autoincrement())
  templateId   Int
  name         String
  title        String
  description  String?
  order        Int
  isRequired   Boolean  @default(false)
  conditionalLogic Json?  // showIf, requireIf conditions
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  template AgencyFormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  fields   FormField[]

  @@index([templateId])
  @@index([order])
  @@index([templateId, order])
  @@map("form_sections")
}

model FormField {
  id               Int       @id @default(autoincrement())
  sectionId        Int
  name             String
  label            String
  type             String    // text, number, date, select, etc.
  isRequired       Boolean   @default(false)
  placeholder      String?
  helpText         String?
  defaultValue     Json?
  validationConfig Json?     // pattern, minLength, maxLength, min, max, customRules
  conditionalLogic Json?     // showIf, requireIf, calculateFrom
  metadata         Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  section FormSection      @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  options FormFieldOption[]

  @@index([sectionId])
  @@index([type])
  @@index([isRequired])
  @@map("form_fields")
}

model FormFieldOption {
  id        Int      @id @default(autoincrement())
  fieldId   Int
  value     String
  label     String
  isDefault Boolean  @default(false)
  order     Int      @default(0)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  field FormField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([fieldId])
  @@index([order])
  @@index([fieldId, order])
  @@map("form_field_options")
}

model FormValidationRule {
  id           Int      @id @default(autoincrement())
  templateId   Int
  type         String   // field, cross_field, business_rule
  conditions   Json     // Field, operator, value
  errorMessage String
  severity     String   // error, warning
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  template AgencyFormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([type])
  @@index([isActive])
  @@map("form_validation_rules")
}

model AgencySubmission {
  id               Int       @id @default(autoincrement())
  tenantId         Int
  clientId         Int
  agencyInfoId     Int
  templateId       Int?
  authority        String    // Authority enum
  documentType     String
  submissionData   Json
  status           String    // ServiceRequestStatus enum
  referenceNumber  String?
  submittedAt      DateTime?
  acknowledgedAt   DateTime?
  processedAt      DateTime?
  approvedAt       DateTime?
  rejectedAt       DateTime?
  rejectionReason  String?
  agencyResponse   Json?     // status, message, documents, nextSteps
  fees             Json      // applicationFee, processingFee, penalties, total, currency, etc.
  internalNotes    String?
  submittedBy      String
  processedBy      String?
  metadata         Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant            Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client            Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  agencyInfo        AgencyInfo           @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)
  template          AgencyFormTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  submittedByUser   User                 @relation("SubmissionSubmitter", fields: [submittedBy], references: [id], onDelete: Restrict)
  processedByUser   User?                @relation("SubmissionProcessor", fields: [processedBy], references: [id], onDelete: SetNull)
  events            SubmissionEvent[]
  workflowExecutions WorkflowExecution[]

  @@index([tenantId])
  @@index([clientId])
  @@index([agencyInfoId])
  @@index([templateId])
  @@index([authority])
  @@index([documentType])
  @@index([status])
  @@index([referenceNumber])
  @@index([submittedAt])
  @@index([submittedBy])
  @@index([processedBy])
  @@index([tenantId, status])
  @@index([clientId, authority])
  @@index([authority, status])
  @@index([tenantId, authority, status])
  @@map("agency_submissions")
}

model SubmissionEvent {
  id           Int      @id @default(autoincrement())
  submissionId Int
  type         String   // submitted, acknowledged, under_review, approved, rejected, etc.
  timestamp    DateTime
  actor        String   // system, client, agency, staff
  actorId      String?
  description  String
  data         Json?
  createdAt    DateTime @default(now())

  submission AgencySubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  actorUser  User?            @relation("EventActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([submissionId])
  @@index([type])
  @@index([timestamp])
  @@index([actor])
  @@index([actorId])
  @@index([submissionId, timestamp])
  @@map("submission_events")
}

model AgencyIntegrationConfig {
  id                    Int      @id @default(autoincrement())
  tenantId              Int
  agencyInfoId          Int
  authority             String   // Authority enum
  isEnabled             Boolean  @default(false)
  apiConfiguration      Json?    // baseUrl, version, authentication, rateLimit, timeout, retryPolicy
  webhookConfiguration  Json?    // inboundUrl, outboundUrls, secret, eventTypes
  dataMapping           Json     // clientFields, documentFields, statusMapping
  testMode              Boolean  @default(true)
  lastHealthCheck       DateTime?
  isHealthy             Boolean  @default(false)
  healthCheckUrl        String?
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agencyInfo AgencyInfo @relation(fields: [agencyInfoId], references: [id], onDelete: Cascade)

  @@unique([tenantId, agencyInfoId])
  @@index([tenantId])
  @@index([agencyInfoId])
  @@index([authority])
  @@index([isEnabled])
  @@index([isHealthy])
  @@index([lastHealthCheck])
  @@map("agency_integration_configs")
}

// ============================================================================
// DYNAMIC SERVICE PACKAGES - DIGITIZED CLIENT FOLDERS
// Service Packages - Dynamic client service subscriptions
// Replaces physical client folders with different service needs
// ============================================================================

model ServicePackage {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  name        String   // "Basic GRA", "Full Compliance", "Business Only", etc.
  description String?
  isActive    Boolean  @default(true)

  // Service inclusions
  includesGRA      Boolean @default(false)
  includesNIS      Boolean @default(false)
  includesDCRA     Boolean @default(false)
  includesImmig    Boolean @default(false)

  // GRA specific services
  graVAT           Boolean @default(false)
  graPAYE          Boolean @default(false)
  graIncomeTax     Boolean @default(false)
  graCorporateTax  Boolean @default(false)

  // NIS specific services
  nisMonthlyReturns   Boolean @default(false)
  nisAnnualReturns    Boolean @default(false)
  nisEmployerReg      Boolean @default(false)
  nisEmployeeReg      Boolean @default(false)

  // DCRA specific services
  dcraBusinessReg     Boolean @default(false)
  dcraCompanyIncorp   Boolean @default(false)
  dcraAnnualReturns   Boolean @default(false)
  dcraNameReserv      Boolean @default(false)

  // Pricing and billing
  monthlyFee      Decimal? @db.Decimal(10, 2)
  perFilingFee    Decimal? @db.Decimal(10, 2)
  setupFee        Decimal? @db.Decimal(10, 2)

  // Client subscriptions
  clientSubscriptions ClientServiceSubscription[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("service_packages")
  @@index([tenantId])
}

model ClientServiceSubscription {
  id              Int      @id @default(autoincrement())
  tenantId        Int
  clientId        Int
  packageId       Int

  // Subscription details
  isActive        Boolean  @default(true)
  startDate       DateTime @default(now())
  endDate         DateTime?
  autoRenew       Boolean  @default(true)

  // Custom service modifications for this client
  customGRAServices    Json? // Custom GRA service selections
  customNISServices    Json? // Custom NIS service selections
  customDCRAServices   Json? // Custom DCRA service selections
  customImmigServices  Json? // Custom Immigration services

  // Billing overrides
  customMonthlyFee     Decimal? @db.Decimal(10, 2)
  customPerFilingFee   Decimal? @db.Decimal(10, 2)
  discountPercent      Int?     @default(0)

  // Status and notes
  status              SubscriptionStatus @default(ACTIVE)
  notes               String?
  lastBillingDate     DateTime?
  nextBillingDate     DateTime?

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client         Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  package        ServicePackage @relation(fields: [packageId], references: [id])

  @@map("client_service_subscriptions")
  @@unique([clientId, packageId])
  @@index([tenantId])
  @@index([clientId])
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
  PENDING_ACTIVATION
}

// Dynamic service requirements based on client type
model ClientTypeTemplate {
  id          String   @id @default(cuid())
  tenantId    Int
  name        String   // "Individual", "Small Business", "Corporation", etc.
  description String?

  // Default service requirements
  requiredServices     Json // Array of required services
  recommendedServices  Json // Array of recommended services
  optionalServices     Json // Array of optional services

  // Workflow templates
  onboardingSteps      Json // Custom onboarding workflow
  complianceChecklist  Json // Regular compliance requirements
  documentRequirements Json // Required documents

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  // NOTE: This relation is defined in Client model as clientTypeTemplate

  @@map("client_type_templates")
  @@index([tenantId])
}

// ============================================================================
// HYBRID PHYSICAL-DIGITAL DOCUMENT MIGRATION SYSTEM
// ============================================================================

// Document Migration Projects - Track physical to digital conversion projects
model DocumentMigrationProject {
  id                Int       @id @default(autoincrement())
  tenantId          Int
  clientId          Int?      // Optional: client-specific migration
  name              String
  description       String?
  status            String    // planning, in_progress, quality_review, completed, cancelled

  // Physical inventory details
  totalPhysicalFiles     Int      @default(0)
  scannedFiles          Int      @default(0)
  processedFiles        Int      @default(0)
  qualityApprovedFiles  Int      @default(0)

  // Estimated metrics
  estimatedDuration     Int?     // in days
  estimatedFileCount    Int?
  estimatedCompletionDate DateTime?

  // Progress tracking
  startDate             DateTime?
  completionDate        DateTime?
  lastActivity          DateTime @default(now())

  // Configuration
  scanSettings          Json     // resolution, color mode, OCR settings
  organizationRules     Json     // folder structure, naming conventions
  qualityStandards      Json     // minimum quality requirements

  // Priority and resources
  priority              String   @default("medium") // low, medium, high, urgent
  assignedTeam          String[]
  estimatedCost         Decimal? @db.Decimal(10, 2)

  // Metadata
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String?

  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client                Client?                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  physicalDocuments     PhysicalDocumentRecord[]
  migrationTasks        DocumentMigrationTask[]
  progressLogs          MigrationProgressLog[]
  transitionWorkflowExecutions TransitionWorkflowExecution[]

  @@map("document_migration_projects")
  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@index([tenantId, status])
}

// Physical Document Records - Track physical documents before/during digitization
model PhysicalDocumentRecord {
  id                    Int       @id @default(autoincrement())
  tenantId              Int
  migrationProjectId    Int
  clientId              Int?

  // Physical location tracking
  physicalLocation      String    // Cabinet, Drawer, Folder location
  fileNumber            String?   // Physical file numbering system
  category              String    // Document category/type
  description           String

  // Physical characteristics
  documentCount         Int       @default(1)
  estimatedPages        Int?
  condition             String    @default("good") // excellent, good, fair, poor
  specialHandling       Boolean   @default(false)

  // Migration status tracking
  migrationStatus       String    @default("pending") // pending, scanning, processing, completed, failed
  digitalDocumentId     Int?      // Link to digital document once created
  scanDate              DateTime?
  processedDate         DateTime?
  qualityCheckDate      DateTime?

  // Quality and notes
  qualityScore          Float?    // 0-100 quality score
  scanNotes             String?
  processingNotes       String?
  qualityNotes          String?

  // Disposal tracking
  disposalScheduled     Boolean   @default(false)
  disposalDate          DateTime?
  disposalMethod        String?   // return_to_client, secure_destruction, archive
  disposalApprovalBy    String?

  // Metadata
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  scannedBy             String?
  processedBy           String?
  qualityCheckedBy      String?

  // Relations
  tenant                Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  migrationProject      DocumentMigrationProject @relation(fields: [migrationProjectId], references: [id], onDelete: Cascade)
  client                Client?                 @relation(fields: [clientId], references: [id], onDelete: SetNull)
  digitalDocument       Document?               @relation(fields: [digitalDocumentId], references: [id], onDelete: SetNull)
  migrationTasks        DocumentMigrationTask[] @relation("DocumentMigrationTasks")
  syncStatuses          DocumentSyncStatus[]

  @@map("physical_document_records")
  @@index([tenantId])
  @@index([migrationProjectId])
  @@index([clientId])
  @@index([migrationStatus])
  @@index([physicalLocation])
  @@index([tenantId, migrationStatus])
}

// Document Migration Tasks - Track specific migration activities
model DocumentMigrationTask {
  id                    Int       @id @default(autoincrement())
  tenantId              Int
  migrationProjectId    Int
  physicalDocumentId    Int?

  // Task details
  title                 String
  description           String?
  taskType              String    // scanning, ocr_processing, quality_review, data_entry, filing
  status                String    @default("pending") // pending, in_progress, completed, failed, cancelled
  priority              String    @default("medium") // low, medium, high, urgent

  // Assignment and timing
  assignedTo            String?
  estimatedDuration     Int?      // in minutes
  startedAt             DateTime?
  completedAt           DateTime?
  dueDate               DateTime?

  // Dependencies and prerequisites
  dependencies          String[]  // IDs of other tasks this depends on
  prerequisites         Json?     // Required conditions before starting

  // Progress and quality
  progressPercentage    Int       @default(0)
  qualityScore          Float?    // 0-100 quality score
  failureReason         String?
  retryCount            Int       @default(0)

  // Notes and metadata
  notes                 String?
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  migrationProject      DocumentMigrationProject  @relation(fields: [migrationProjectId], references: [id], onDelete: Cascade)
  physicalDocument      PhysicalDocumentRecord?   @relation(fields: [physicalDocumentId], references: [id], onDelete: SetNull, name: "DocumentMigrationTasks")

  @@map("document_migration_tasks")
  @@index([tenantId])
  @@index([migrationProjectId])
  @@index([status])
  @@index([assignedTo])
  @@index([tenantId, status])
  @@index([dueDate])
}

// Migration Progress Logs - Detailed activity tracking
model MigrationProgressLog {
  id                    Int       @id @default(autoincrement())
  tenantId              Int
  migrationProjectId    Int

  // Event details
  eventType             String    // scan_started, scan_completed, quality_check, etc.
  eventDescription      String
  eventData             Json?     // Additional event-specific data

  // Metrics snapshot
  filesScanned          Int?
  filesProcessed        Int?
  filesApproved         Int?
  qualityScore          Float?

  // Actor and timing
  actorId               String?   // User who performed the action
  timestamp             DateTime  @default(now())

  // Metadata
  metadata              Json?

  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  migrationProject      DocumentMigrationProject  @relation(fields: [migrationProjectId], references: [id], onDelete: Cascade)
  actor                 User?                     @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@map("migration_progress_logs")
  @@index([tenantId])
  @@index([migrationProjectId])
  @@index([timestamp])
  @@index([eventType])
}

// Document Sync Status - Track sync between physical and digital versions
model DocumentSyncStatus {
  id                    Int       @id @default(autoincrement())
  tenantId              Int
  digitalDocumentId     Int
  physicalDocumentId    Int?

  // Sync status
  syncStatus            String    @default("pending") // synced, pending, conflict, failed
  lastSyncDate          DateTime?
  syncVersion           Int       @default(1)

  // Version tracking
  digitalVersion        String?   // Version identifier for digital document
  physicalVersion       String?   // Version identifier for physical document

  // Conflict resolution
  conflictType          String?   // version_mismatch, content_difference, metadata_conflict
  conflictDescription   String?
  conflictResolution    String?   // manual_review, prefer_digital, prefer_physical
  resolvedBy            String?
  resolvedAt            DateTime?

  // Notifications
  clientNotified        Boolean   @default(false)
  clientNotifiedAt      DateTime?
  notificationMethod    String?   // email, sms, portal_message

  // Metadata
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  tenant                Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  digitalDocument       Document                @relation(fields: [digitalDocumentId], references: [id], onDelete: Cascade)
  physicalDocument      PhysicalDocumentRecord? @relation(fields: [physicalDocumentId], references: [id], onDelete: SetNull)

  @@unique([tenantId, digitalDocumentId])
  @@map("document_sync_status")
  @@index([tenantId])
  @@index([syncStatus])
  @@index([digitalDocumentId])
}

// Legacy Data Import Jobs - Track bulk data migration from legacy systems
model LegacyDataImportJob {
  id                    Int       @id @default(autoincrement())
  tenantId              Int

  // Import job details
  name                  String
  description           String?
  sourceSystem          String    // quickbooks, excel, paper_records, etc.
  sourceLocation        String?   // File path or system identifier

  // Status and progress
  status                String    @default("pending") // pending, running, completed, failed, cancelled
  totalRecords          Int?      // Total records to import
  processedRecords      Int       @default(0)
  successfulRecords     Int       @default(0)
  failedRecords         Int       @default(0)

  // Data mapping configuration
  fieldMapping          Json      // Source field to target field mappings
  transformationRules   Json      // Data transformation and validation rules
  dataFilters           Json?     // Filters to apply during import

  // Import settings
  batchSize             Int       @default(100)
  validateData          Boolean   @default(true)
  skipDuplicates        Boolean   @default(true)
  updateExisting        Boolean   @default(false)

  // Quality control
  qualityThreshold      Float     @default(0.95) // Minimum quality score to accept
  manualReviewRequired  Boolean   @default(false)

  // Timing
  scheduledStartTime    DateTime?
  actualStartTime       DateTime?
  completionTime        DateTime?
  estimatedDuration     Int?      // in minutes

  // Results and logs
  importSummary         Json?     // Summary of import results
  errorLog              Json?     // Detailed error information
  warningLog            Json?     // Warning messages

  // Metadata
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String?

  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  importRecords         LegacyDataImportRecord[]

  @@map("legacy_data_import_jobs")
  @@index([tenantId])
  @@index([status])
  @@index([tenantId, status])
  @@index([sourceSystem])
}

// Legacy Data Import Records - Individual record import tracking
model LegacyDataImportRecord {
  id                    Int       @id @default(autoincrement())
  tenantId              Int
  importJobId           Int

  // Record identification
  sourceRecordId        String?   // ID in source system
  recordType            String    // client, document, transaction, etc.

  // Import status
  status                String    @default("pending") // pending, imported, failed, skipped, duplicate
  importedEntityId      Int?      // ID of created entity in target system
  importedEntityType    String?   // Table/model name of imported entity

  // Source data
  sourceData            Json      // Original data from source system
  transformedData       Json?     // Data after transformation rules

  // Quality and validation
  qualityScore          Float?    // 0-1 quality score
  validationErrors      String[]  // Validation error messages
  validationWarnings    String[]  // Validation warning messages

  // Conflict resolution
  isDuplicate           Boolean   @default(false)
  duplicateOf           Int?      // ID of existing record this duplicates
  conflictResolution    String?   // skip, merge, replace, manual_review

  // Processing details
  processedAt           DateTime?
  processingDuration    Int?      // in milliseconds
  retryCount            Int       @default(0)
  lastError             String?

  // Metadata
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  tenant                Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  importJob             LegacyDataImportJob   @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  @@map("legacy_data_import_records")
  @@index([tenantId])
  @@index([importJobId])
  @@index([status])
  @@index([recordType])
  @@index([sourceRecordId])
  @@index([tenantId, status])
}

// Transition Workflow Templates - Predefined workflows for migration
model TransitionWorkflowTemplate {
  id                    Int       @id @default(autoincrement())
  tenantId              Int

  // Template details
  name                  String
  description           String?
  workflowType          String    // client_onboarding, document_migration, system_training
  clientTypes           String[]  // Which client types this applies to

  // Workflow definition
  steps                 Json      // Ordered list of workflow steps
  estimatedDuration     Int?      // Total estimated duration in days
  requiredSkills        String[]  // Skills needed to execute this workflow

  // Configuration
  isActive              Boolean   @default(true)
  version               String    @default("1.0")
  checklistItems        Json?     // Quality checkpoints
  successCriteria       Json?     // Criteria for successful completion

  // Usage tracking
  timesUsed             Int       @default(0)
  averageDuration       Int?      // in days
  successRate           Float?    // 0-1 success rate

  // Metadata
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String?

  // Relations
  tenant                Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflowExecutions    TransitionWorkflowExecution[]

  @@map("transition_workflow_templates")
  @@index([tenantId])
  @@index([workflowType])
  @@index([isActive])
  @@index([tenantId, workflowType])
}

// Transition Workflow Executions - Active workflow instances
model TransitionWorkflowExecution {
  id                    Int       @id @default(autoincrement())
  tenantId              Int
  templateId            Int
  clientId              Int?
  migrationProjectId    Int?

  // Execution details
  name                  String
  status                String    @default("pending") // pending, active, completed, cancelled, failed
  currentStepIndex      Int       @default(0)

  // Progress tracking
  totalSteps            Int
  completedSteps        Int       @default(0)
  progressPercentage    Int       @default(0)

  // Timing
  startedAt             DateTime?
  scheduledCompletion   DateTime?
  actualCompletion      DateTime?
  totalDuration         Int?      // in days

  // Assignment
  assignedTo            String?
  supervisorId          String?

  // Step execution tracking
  stepStatuses          Json      // Array of step completion statuses
  stepNotes             Json?     // Notes for each step
  checkpointResults     Json?     // Quality checkpoint results

  // Client interaction
  clientFeedback        String?
  clientSatisfaction    Float?    // 0-5 satisfaction rating

  // Metadata
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  tenant                Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template              TransitionWorkflowTemplate  @relation(fields: [templateId], references: [id], onDelete: Restrict)
  client                Client?                     @relation(fields: [clientId], references: [id], onDelete: SetNull)
  migrationProject      DocumentMigrationProject?   @relation(fields: [migrationProjectId], references: [id], onDelete: SetNull)

  @@map("transition_workflow_executions")
  @@index([tenantId])
  @@index([templateId])
  @@index([clientId])
  @@index([status])
  @@index([tenantId, status])
  @@index([assignedTo])
}

// Enhanced models with migration support

